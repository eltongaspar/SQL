SELECT SD3.D3_COD AS [PRODUTO], 
SD3.D3_QUANT AS [QTD], 
SD3.D3_LOCAL AS [ARMZ], 
SD3.D3_EMISSAO AS [EMISSAO], 
SD3.D3_OP AS [OP], 
SD3.D3_HIST AS [HIST], 
SD3.D3_USUARIO AS [USUARIO], 
(SD3.D3_QUANT * SB1.B1_PESPVC) AS [PVC], 
(SD3.D3_QUANT * SB1.B1_PESCOB) AS [COBRE], 
SD3.D3_CF AS [TPMOV], 
SD3.D3_DOC AS [DOC], 
SD3.D3_NUMSEQ AS [SEQ], 
SD3.R_E_C_N_O_ AS [REC] 
FROM SD3010 SD3 
INNER JOIN SB1010 SB1 ON SD3.D3_COD = SB1.B1_COD AND SD3.D_E_L_E_T_ = SB1.D_E_L_E_T_ 
WHERE SD3.D3_FILIAL = '01' 
AND SD3.D3_EMISSAO >= '20230901' 
AND SD3.D3_EMISSAO <= '20230930' 
AND SD3.D3_CF IN ('RE7','RE4') 
AND SD3.D3_NUMSEQ NOT IN ( 
						SELECT SSD3.D3_NUMSEQ 
						FROM SD3010 SSD3 
						WHERE SSD3.D3_FILIAL = SD3.D3_FILIAL 
						AND SSD3.D3_EMISSAO >= '20230901' 
						AND SSD3.D3_EMISSAO <= '20230930' 
						AND SSD3.D3_CF IN ('DE7','DE4') 
						AND SSD3.D3_ESTORNO = SD3.D3_ESTORNO 
						AND SSD3.D_E_L_E_T_ = SD3.D_E_L_E_T_  
) 
AND SD3.D3_ESTORNO <> 'S' 
 
UNION 
 
SELECT SD3.D3_COD AS [PRODUTO], 
SD3.D3_QUANT AS [QTD], 
SD3.D3_LOCAL AS [ARMZ], 
SD3.D3_EMISSAO AS [EMISSAO], 
SD3.D3_OP AS [OP], 
SD3.D3_HIST AS [HIST], 
SD3.D3_USUARIO AS [USUARIO], 
(SD3.D3_QUANT * SB1.B1_PESPVC) AS [PVC], 
(SD3.D3_QUANT * SB1.B1_PESCOB) AS [COBRE], 
SD3.D3_CF AS [TPMOV], 
SD3.D3_DOC AS [DOC], 
SD3.D3_NUMSEQ AS [SEQ], 
SD3.R_E_C_N_O_ AS [REC] 
FROM SD3010 SD3 
INNER JOIN SB1010 SB1 ON SD3.D3_COD = SB1.B1_COD AND SD3.D_E_L_E_T_ = SB1.D_E_L_E_T_ 
WHERE SD3.D3_FILIAL = '01' 
AND SD3.D3_EMISSAO >= '20230901' 
AND SD3.D3_EMISSAO <= '20230930' 
AND SD3.D3_CF IN ('DE7','DE4') 
AND SD3.D3_NUMSEQ NOT IN ( 
						SELECT SSD3.D3_NUMSEQ 
						FROM SD3010 SSD3 
						WHERE SSD3.D3_FILIAL = SD3.D3_FILIAL 
						AND SSD3.D3_EMISSAO >= '20230901' 
						AND SSD3.D3_EMISSAO <= '20230930' 
						AND SSD3.D3_CF IN ('RE7','RE4') 
						AND SSD3.D3_ESTORNO = SD3.D3_ESTORNO 
						AND SSD3.D_E_L_E_T_ = SD3.D_E_L_E_T_  
) 
AND SD3.D3_ESTORNO <> 'S' 