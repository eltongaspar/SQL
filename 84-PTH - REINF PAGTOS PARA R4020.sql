SELECT SE2.E2_FILIAL AS [FILIAL],
C20.C20_CHVNF AS [CHVNF],
C20.C20_CODPAR AS [PARTIC],
C1H.C1H_CODPAR AS [CODPAR],
C20.C20_NUMDOC AS [NUMDOC],
C20.C20_SERIE AS [SERIE],
C20.C20_DTDOC AS [EMISS],
0 AS [NATTIT],
SE2.E2_PARCELA AS [PARCELA],
FK2.FK2_DATA AS [PAGTO],
--FK2.FK2_VALOR AS [VAL_PAGTO],
'' AS [SEQ],
ISNULL(V3O.V3O_ID,'') AS [ID_NATREN],
ISNULL(V3O.V3O_CODIGO,'') AS [NATREN],
ISNULL(V3O.V3O_DESCR,'') AS [DESC_NATREN],
ISNULL(V3O.R_E_C_N_O_,0) AS [REC_V3O],
CASE
	WHEN C35.C35_CODTRI IN ('000011','000018','000010')
		THEN ('000029')
	ELSE C35.C35_CODTRI
END AS [CODTRI],
ISNULL(C3S.R_E_C_N_O_,0) AS [REC_C3S],
CASE
	WHEN SE2.E2_COFINS > 0 
		THEN  SE2.E2_BASECOF
	WHEN SE2.E2_PIS > 0 
		THEN SE2.E2_BASEPIS
	ELSE SE2.E2_BASECOF
END AS [BASE],
--C35.C35_BASE AS [BASE],
--SUM(C35.C35_VALOR) AS [VALOR]
(SE2.E2_COFINS + SE2.E2_PIS + SE2.E2_CSLL) AS [VALOR]
--SUM(FK2.FK2_VALOR) AS [BASE],
--ROUND(SUM(FK2.FK2_VALOR * (C35.C35_ALIQ / 100)),2) AS [VALOR]
FROM SE2010 SE2  
INNER JOIN SA2010 SA2  ON SA2.A2_FILIAL = '  ' 
					AND SA2.A2_COD = SE2.E2_FORNECE 
					AND SA2.A2_LOJA = SE2.E2_LOJA  
					AND SA2.D_E_L_E_T_ = ' '
INNER JOIN SED010 SED  ON SED.ED_FILIAL = '  ' 
					AND SED.ED_CODIGO = SE2.E2_NATUREZ  
					AND SED.D_E_L_E_T_ = ' ' 
LEFT JOIN FK7010 FK7  ON FK7.FK7_FILIAL = SE2.E2_FILIAL  
					AND FK7.FK7_ALIAS = 'SE2' 
					AND  FK7.FK7_FILTIT = SE2.E2_FILIAL  
					AND FK7.FK7_PREFIX = SE2.E2_PREFIXO 
					AND FK7.FK7_NUM = SE2.E2_NUM  
					AND FK7.FK7_PARCEL = SE2.E2_PARCELA  
					AND FK7.FK7_TIPO = SE2.E2_TIPO  
					AND FK7.FK7_CLIFOR = SE2.E2_FORNECE  
					AND FK7.FK7_LOJA = SE2.E2_LOJA  
					AND FK7.D_E_L_E_T_ = ' '
LEFT JOIN FKF010 FKF  ON FKF.FKF_FILIAL = SE2.E2_FILIAL  
					AND  FKF.FKF_IDDOC = FK7.FK7_IDDOC 
					AND FKF.D_E_L_E_T_ = ' '
LEFT JOIN FKJ010 FKJ  ON FKJ.FKJ_FILIAL = '  ' 
					AND  FKJ.FKJ_COD = A2_COD 
					AND FKJ_LOJA = A2_LOJA 
					AND FKJ.D_E_L_E_T_ = ' '
INNER JOIN (SELECT SFK2.FK2_FILIAL AS [FK2_FILIAL],
			SFK2.FK2_IDDOC AS [FK2_IDDOC],
			MAX(SFK2.FK2_DATA) AS [FK2_DATA]
			FROM FK2010 SFK2
			WHERE SFK2.D_E_L_E_T_ = ' '  
			--AND FK2.FK2_REINF IN ('2',' ')  
			AND SFK2.FK2_RECPAG = 'P'  
			AND SFK2.FK2_TPDOC NOT IN ('DC','D2','JR','J2','TL','MT','M2','CM','C2','TR','TE','E2','CH','ES','PA')  
			AND SFK2.FK2_MOTBX NOT IN ('FAT','LIQ','DEV') 
			AND SFK2.FK2_DATA >= '20240201' 
			AND SFK2.FK2_DATA <= '20240229'  
			AND NOT EXISTS(  	
							SELECT FK2EST.FK2_IDDOC 
							FROM FK2010 FK2EST 	
							WHERE FK2EST.FK2_FILIAL = SFK2.FK2_FILIAL 	
							AND FK2EST.FK2_IDDOC = SFK2.FK2_IDDOC  	
							AND FK2EST.FK2_SEQ = SFK2.FK2_SEQ  	
							AND FK2EST.FK2_TPDOC = 'ES'  	
							AND FK2EST.D_E_L_E_T_ = SFK2.D_E_L_E_T_
			) 
			GROUP BY SFK2.FK2_FILIAL,
			SFK2.FK2_IDDOC
) FK2 ON FK2.FK2_FILIAL = SE2.E2_FILIAL 
	AND FK2.FK2_IDDOC = FK7.FK7_IDDOC  
INNER JOIN SD1010 SD1 ON SE2.E2_FILIAL = SD1.D1_FILIAL
					AND SE2.E2_NUM = SD1.D1_DOC
					AND SE2.E2_PREFIXO = SD1.D1_SERIE
					AND SE2.E2_FORNECE = SD1.D1_FORNECE
					AND SE2.E2_LOJA = SD1.D1_LOJA
					AND SE2.D_E_L_E_T_ = SD1.D_E_L_E_T_

INNER JOIN C20010 C20 ON SD1.D1_FILIAL = C20.C20_FILIAL
				AND SD1.D1_DOC = C20.C20_NUMDOC
				AND SD1.D1_SERIE = C20.C20_SERIE
				AND 'F' + SD1.D1_FORNECE+SD1.D1_LOJA = (SELECT TOP 1 C1H.C1H_CODPAR
														FROM C1H010 C1H
														WHERE C1H.C1H_FILIAL = ''
														AND C1H.C1H_ID = C20.C20_CODPAR
														AND C1H.D_E_L_E_T_ = C20.D_E_L_E_T_
														)
				AND SD1.D_E_L_E_T_ = C20.D_E_L_E_T_	
INNER JOIN C30010 C30 ON C20.C20_FILIAL = C30.C30_FILIAL
					AND C20.C20_CHVNF = C30.C30_CHVNF
					AND SD1.D1_ITEM = C30.C30_NUMITE
					AND C20.D_E_L_E_T_ = C30.D_E_L_E_T_
LEFT JOIN V3O010 V3O ON '' = V3O.V3O_FILIAL
					AND C30.C30_CNATRE = V3O.V3O_ID
					AND C30.D_E_L_E_T_ = V3O.D_E_L_E_T_
INNER JOIN C35010 C35 ON C30.C30_FILIAL = C35.C35_FILIAL
					AND C30.C30_CHVNF = C35.C35_CHVNF
					AND C30.C30_NUMITE = C35.C35_NUMITE
					AND C30.D_E_L_E_T_ = C35.D_E_L_E_T_
LEFT JOIN V3U010 V3U ON C20.C20_FILIAL = V3U.V3U_FILIAL
					AND C20.C20_NUMDOC = V3U.V3U_NUMERO
					AND C20.C20_SERIE = V3U.V3U_SERIE
					AND C20.C20_CODPAR = V3U.V3U_IDPART
					AND SE2.E2_PARCELA = V3U.V3U_PARCEL
					AND FK2.FK2_DATA = V3U.V3U_DTPAGT
					AND C20.D_E_L_E_T_ = V3U.D_E_L_E_T_
INNER JOIN C1H010 C1H ON '' = C1H.C1H_FILIAL
					AND C20.C20_CODPAR = C1H.C1H_ID
					AND C20.D_E_L_E_T_ = C1H.D_E_L_E_T_
LEFT JOIN C3S010 C3S ON '' = C3S.C3S_FILIAL
					AND (CASE
							WHEN C35.C35_CODTRI IN ('000011','000018','000010')
								THEN ('000029')
							ELSE C35.C35_CODTRI
						END) = C3S.C3S_ID
					AND C20.D_E_L_E_T_ = C3S.D_E_L_E_T_
WHERE E2_FILIAL IN ('01','02','03')
AND SE2.E2_TIPO NOT IN ('AB-','CF-','CS-','FB-','FC-','FE-','FM-','FP-','FU-','GN-','I2-','IB-','IM-','IN-','IR-','IS-','IV-','MN-','PI-','FC-','FE-','PR ','NDF','DIC','IR-','CS-','CF-','PI-','ISS','TX ','TXA','INS','SES')   
AND SE2.E2_FILORIG = SE2.E2_FILIAL  
AND SE2.D_E_L_E_T_ = ' '  
AND (SE2.E2_COFINS > 0 OR SE2.E2_PIS > 0 OR SE2.E2_CSLL >0)
AND SE2.E2_EMISSAO <= '20240229'   
AND SE2.E2_BAIXA <> ''
AND SE2.E2_BAIXA <= '20240229'
AND C20.C20_DTDOC >= '20240201'
AND V3U.V3U_ID IS NULL
--AND V3O.V3O_ID IS NULL --SOMENTE AS QUE ESTÃO SEM NATRENDIMENTO PARA PREENCHER ANTES
--AND C20_CHVNF = '000000000281187'
--AND C20_CHVNF = '000000000280980'
AND C35.C35_CODTRI IN ('000011','000018','000010')
GROUP BY SE2.E2_FILIAL,
C20.C20_CHVNF,
C20.C20_CODPAR,
C1H.C1H_CODPAR,
C20.C20_NUMDOC,
C20.C20_SERIE,
C20.C20_DTDOC,
SE2.E2_PARCELA,
FK2.FK2_DATA,
--FK2.FK2_VALOR,
ISNULL(V3O.V3O_ID,''),
ISNULL(V3O.V3O_CODIGO,''),
ISNULL(V3O.V3O_DESCR,''),
ISNULL(V3O.R_E_C_N_O_,0),
CASE
	WHEN C35.C35_CODTRI IN ('000011','000018','000010')
		THEN ('000029')
	ELSE C35.C35_CODTRI
END,
ISNULL(C3S.R_E_C_N_O_,0),
--C35.C35_BASE
CASE
	WHEN SE2.E2_COFINS > 0 
		THEN  SE2.E2_BASECOF
	WHEN SE2.E2_PIS > 0 
		THEN SE2.E2_BASEPIS
	ELSE SE2.E2_BASECOF
END,
(SE2.E2_COFINS + SE2.E2_PIS + SE2.E2_CSLL)
ORDER BY SE2.E2_FILIAL,
C20.C20_CHVNF,
C20.C20_CODPAR,
C1H.C1H_CODPAR,
C20.C20_NUMDOC,
C20.C20_SERIE,
C20.C20_DTDOC,
SE2.E2_PARCELA,
FK2.FK2_DATA,
--FK2.FK2_VALOR,
ISNULL(V3O.V3O_ID,''),
ISNULL(V3O.V3O_CODIGO,''),
ISNULL(V3O.V3O_DESCR,'')


/*


SELECT *
FROM C30010
WHERE C30_FILIAL = '01'
AND C30_CHVNF = '000000000280925'
AND D_E_L_E_T_ = ''

SELECT *
FROM C35010
WHERE C35_FILIAL = '01'
AND C35_CHVNF = '000000000281187'
AND D_E_L_E_T_ = ''

SELECT *
FROM V3O010
WHERE V3O_ID = '000147'


SELECT *
FROM C3S010



SELECT *
FROM C20010
WHERE C20_FILIAL = '01'
AND C20_CHVNF= '000000000281137'
AND D_E_L_E_T_ = ''

SELECT *
FROM V3U010 with(nolock)
WHERE V3U_NUMERO = '00110283'
AND D_E_L_E_T_ = ''

SELECT *
FROM V3V010  with(nolock)
WHERE V3V_ID = '23c8f15b-aafd-bce1-a153-30013df92b9c'


SELECT *
FROM V46010 with(nolock)
WHERE V46_ID = '23c8f15b-aafd-bce1-a153-30013df92b9c'


SELECT *
FROM V47010

SELECT *
FROM SD1010
WHERE D1_FILIAL = '01'
AND D1_DOC = '002145'
AND D1_FORNECE = 'V00392'
AND D_E_L_E_T_ = ''


SELECT *
FROM C20010
WHERE C20_FILIAL = '01'
AND C20_NUMDOC= '00110283'
AND D_E_L_E_T_ = ''

000029
*/